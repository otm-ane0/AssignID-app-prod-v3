generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                String              @id @unique @default(uuid())
  name              String
  logo              String
  color             String
  secret            ClientSecret[]
  origins           String[]
  // callback_url      String?
  createdAt         DateTime            @default(now()) @map(name: "created_at")
  ClientAuthSession ClientAuthSession[]

  @@map(name: "clients")
}

model ClientSecret {
  id        Int     @id @default(autoincrement())
  token     String  @unique
  expireAt  String  @map(name: "expire_at")
  createdAt String  @map(name: "created_at")
  client    Client? @relation(fields: [clientId], references: [id])
  clientId  String?

  @@map(name: "client_secrets")
}

model ClientAuthSession {
  id                 String               @id @unique @default(uuid())
  client             Client               @relation(fields: [clientId], references: [id])
  secret             String // session secret
  status             AuthSessionStatus    @default(Waiting)
  successAccount     Account?             @relation(fields: [accountId], references: [id]) // which account got logined with this
  createdAt          String // unix datetime (will be expired in 5 minutes)
  updatedAt          String
  clientId           String
  connectedClientId  String?
  connectedAccountId String?
  accountId          String?
  extraInfo          String? // device ip browser in json
  type               AuthSessionType
  accountAccessToken AccountAccessToken[]

  @@map(name: "client_auth_sessions")
}

model AccountAccessToken {
  id                  Int               @id @unique @default(autoincrement())
  authSession         ClientAuthSession @relation(fields: [clientAuthSessionId], references: [id])
  accessToken         String // will be generated by session_secret + assign_id_jwt_secret
  sourceApp           String?
  connectedApp        String?
  isRevoked           Boolean           @default(false)
  expireAt            String?
  createdAt           String
  clientAuthSessionId String

  @@map(name: "account_access_tokens")
}

model NativeAccountAuthCookie {
  id              Int      @id @unique @default(autoincrement())
  cookieToken     String   @map(name: "cookie_token")
  nativeAccountId String   @map(name: "native_account_id")
  createdAt       DateTime @default(now()) @map(name: "created_at")

  @@map(name: "native_account_auth_cookie")
}

enum AuthSessionType {
  ConnectApp
  PopupSession
  LinkSocialAccount
  UnlinkSocialAccount
}

enum AuthSessionStatus {
  Waiting
  Failed
  Success
}

model Account {
  id         String   @id @unique @default(uuid())
  assignId   String   @unique
  firstName  String?  @map(name: "first_name")
  familyName String?  @map(name: "family_name")
  picture    String?
  createdAt  DateTime @default(now()) @map(name: "created_at")
  newsletter Boolean? @default(true)
  setted_up  Boolean? @default(false)

  connections  SocialConnection[]
  authSessions ClientAuthSession[]

  @@map(name: "accounts")
}

model NativeAccount {
  id        String   @id @unique @default(uuid())
  userName  String   @unique @map(name: "user_name")
  password  String
  verified  Boolean  @default(false)
  picture   String?
  createdAt DateTime @default(now()) @map(name: "created_at")

  @@map(name: "native_accounts")
}

model AccountChallenge {
  id              String   @id @unique @default(uuid())
  nativeAccountId String   @map(name: "native_account_id")
  otpCode         String
  createdAt       DateTime @default(now()) @map(name: "created_at")

  @@map(name: "account_challenges")
}

model SocialConnection {
  id               Int            @id @default(autoincrement())
  provider         SocialProvider
  providerId       String         @map(name: "provider_id")
  providerUsername String         @map(name: "provider_username") // Provider username, for google: "Email", facebook: "Username"
  lastUsed         String         @map(name: "last_used")
  connectedAt      String         @map(name: "created_at")

  token     SocialConnectionToken @relation(fields: [tokenId], references: [id])
  account   Account?              @relation(fields: [accountId], references: [id])
  accountId String?               @map(name: "account_id")
  tokenId   Int                   @unique @map(name: "token_id")

  @@map(name: "social_connections")
}

model SocialConnectionToken {
  id           Int                @id @default(autoincrement())
  accessToken  String             @map(name: "access_token")
  refreshToken String?            @map(name: "refresh_token")
  expireAt     String?            @map(name: "expiry_at")
  createdAt    String             @map(name: "created_at") // unix timestamp
  connections  SocialConnection[]

  @@map(name: "social_connection_tokens")
}

model SessionHelper {
  id         Int    @id @default(autoincrement())
  helperVal1 String @unique @map(name: "helper_val_1")
  helperVal2 String @unique @map(name: "helper_val_2")
  clientId   String
  sessionId  String
}

enum SocialProvider {
  Google
  Facebook
  Twitter
  Native
}
